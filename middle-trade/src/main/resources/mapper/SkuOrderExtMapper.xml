<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="SkuOrderExt">

    <resultMap id="skuOrderLockStock" type="SkuOrderLockStock">
        <result column="sku_code" property="skuCode"/>
        <result column="quantity" property="quantity"/>
        <result column="shop_id" property="shopId"/>
        <result column="company_id" property="warehouseId"/>
    </resultMap>

    <sql id="tb">
        parana_sku_orders
    </sql>
    <update id="updateSkuInfoById" parameterType="SkuOrderExt">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now()
        <if test="skuId != null">,`sku_id` = #{skuId}</if>
        <if test="skuCode != null">,`sku_code` = #{skuCode}</if>
        <if test="name != null">,`item_name` = #{name}</if>
        <if test="skuAttributes !=null">,`sku_attributes` = #{skuAttributes}</if>
        WHERE id=#{id}
    </update>

    <update id="updateBuyerNameByOrderId" parameterType="map">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now()
        ,`buyer_name` = #{buyerName}
        WHERE order_id=#{orderId}
    </update>

    <select id="findOccupyGroup" parameterType="list" resultMap="skuOrderLockStock">
        SELECT
        sku_code,
        shop_id,
        company_id,
        sum(quantity) as quantity
        FROM
        <include refid="tb"/>
        WHERE
         `status` !=-7
        <if test="shopIds != null">
            AND shop_id IN
            <foreach collection="shopIds" open="(" separator="," close=")" item="shopId">
                #{shopId}
            </foreach>
        </if>
        <if test="warehouseIds != null">
            AND company_id IN
            <foreach collection="warehouseIds" open="(" separator="," close=")" item="warehouseId">
                #{warehouseId}
            </foreach>
        </if>
        <if test="skuCodes != null">
            AND sku_code IN
            <foreach collection="skuCodes" open="(" separator="," close=")" item="skuCode">
                #{skuCode}
            </foreach>
        </if>
        <if test="type != null">
            AND `type` =#{type}
        </if>
        GROUP BY sku_code,company_id,shop_id
    </select>


    <select id="findSkuCodesByOrderIds" parameterType="list" resultType="string">
        SELECT
          sku_code
        FROM
        <include refid="tb"/>
        WHERE
        <if test="orderIds != null">
            order_id IN
            <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                #{orderId}
            </foreach>
        </if>
        GROUP BY sku_code
    </select>
    
    <!-- RAY 2019.04.25 新增自定義查詢 -->
    <resultMap id="SkuOrderMap" type="SkuOrder">
        <id column="id" property="id"/>
        <result column="sku_id" property="skuId"/>
        <result column="quantity" property="quantity"/>
        <result column="with_hold" property="withHold"/>
        <result column="shipping" property="shipping"/>
        <result column="shipped" property="shipped"/>
        <result column="fee" property="fee"/>
        <result column="status" property="status"/>
        <result column="type" property="type"/>
        <result column="order_id" property="orderId"/>
        <result column="buyer_id" property="buyerId"/>
        <result column="out_id" property="outId"/>
        <result column="buyer_name" property="buyerName"/>
        <result column="out_buyer_id" property="outBuyerId"/>
        <result column="item_id" property="itemId"/>
        <result column="item_name" property="itemName"/>
        <result column="sku_image" property="skuImage"/>
        <result column="sku_code" property="skuCode"/>
        <result column="attrs_json" property="attrsJson"/>
        <result column="shop_id" property="shopId"/>
        <result column="shop_name" property="shopName"/>
        <result column="out_shop_id" property="outShopId"/>
        <result column="company_id" property="companyId"/>
        <result column="out_sku_id" property="outSkuId"/>
        <result column="sku_attributes" property="skuAttributes"/>
        <result column="channel" property="channel"/>
        <result column="pay_type" property="payType"/>
        <result column="shipment_type" property="shipmentType"/>
        <result column="origin_fee" property="originFee"/>
        <result column="discount" property="discount"/>
        <result column="ship_fee" property="shipFee"/>
        <result column="ship_fee_discount" property="shipFeeDiscount"/>
        <result column="integral" property="integral"/>
        <result column="balance" property="balance"/>
        <result column="item_snapshot_id" property="itemSnapshotId"/>
        <result column="has_refund" property="hasRefund"/>
        <result column="invoiced" property="invoiced"/>
        <result column="commented" property="commented"/>
        <result column="has_apply_after_sale" property="hasApplyAfterSale"/>
        <result column="commission_rate" property="commissionRate"/>
        <result column="distribution_rate" property="distributionRate"/>
        <result column="diff_fee" property="diffFee"/>
        <result column="out_order_id" property="outOrderId"/>
        <result column="extra_json" property="extraJson"/>
        <result column="tags_json" property="tagsJson"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <sql id="cols_all">
        id,
        <include refid="cols_exclude_id"/>
    </sql>

    <sql id="cols_exclude_id">
        `sku_id`,`quantity`,`with_hold`,`shipping`, `shipped`, `fee`,`status`,`type`, `order_id`,`buyer_id`,`out_id`,`buyer_name`,`out_buyer_id`,`item_id`,
        `item_name`,`sku_image`,`sku_code`,`shop_id`,`shop_name`,`out_shop_id`,`company_id`,`out_sku_id`,
        `sku_attributes`,`channel`,`pay_type`,`shipment_type`,`origin_fee`,`discount`,
        `ship_fee`,`ship_fee_discount`,`integral`,`balance`,`item_snapshot_id`,`has_refund`,`invoiced`,
        `commented`, `has_apply_after_sale` , `commission_rate`,`distribution_rate`, `diff_fee` ,`out_order_id`,`extra_json`,`tags_json`,`created_at`,`updated_at`
    </sql>
    <select id="findSkuCodesByOrderIdAndOriginSkuCode" parameterType="map" resultMap="SkuOrderMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE order_id=#{orderId} AND extra_json ->> '$.originSkuCode'=#{originSkuCode} AND sku_id=0
    </select>
    <!-- RAY 2019.04.25 新增自定義查詢 END -->
</mapper>
