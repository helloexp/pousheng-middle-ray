<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="SkuOrderExt">

    <resultMap id="skuOrderLockStock" type="SkuOrderLockStock">
        <result column="sku_code" property="skuCode"/>
        <result column="quantity" property="quantity"/>
        <result column="shop_id" property="shopId"/>
        <result column="company_id" property="warehouseId"/>
    </resultMap>

    <sql id="tb">
        parana_sku_orders
    </sql>
    <update id="updateSkuInfoById" parameterType="SkuOrderExt">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now()
        <if test="skuId != null">,`sku_id` = #{skuId}</if>
        <if test="skuCode != null">,`sku_code` = #{skuCode}</if>
        <if test="name != null">,`item_name` = #{name}</if>
        <if test="skuAttributes !=null">,`sku_attributes` = #{skuAttributes}</if>
        WHERE id=#{id}
    </update>

    <update id="updateBuyerNameByOrderId" parameterType="map">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now()
        ,`buyer_name` = #{buyerName}
        WHERE order_id=#{orderId}
    </update>

    <select id="findOccupyGroup" parameterType="list" resultMap="skuOrderLockStock">
        SELECT
        sku_code,
        shop_id,
        company_id,
        sum(quantity) as quantity
        FROM
        <include refid="tb"/>
        WHERE
         `status` !=-7
        <if test="shopIds != null">
            AND shop_id IN
            <foreach collection="shopIds" open="(" separator="," close=")" item="shopId">
                #{shopId}
            </foreach>
        </if>
        <if test="warehouseIds != null">
            AND company_id IN
            <foreach collection="warehouseIds" open="(" separator="," close=")" item="warehouseId">
                #{warehouseId}
            </foreach>
        </if>
        <if test="skuCodes != null">
            AND sku_code IN
            <foreach collection="skuCodes" open="(" separator="," close=")" item="skuCode">
                #{skuCode}
            </foreach>
        </if>
        <if test="type != null">
            AND `type` =#{type}
        </if>
        GROUP BY sku_code,company_id,shop_id
    </select>


    <select id="findSkuCodesByOrderIds" parameterType="list" resultType="string">
        SELECT
          sku_code
        FROM
        <include refid="tb"/>
        WHERE
        <if test="orderIds != null">
            order_id IN
            <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                #{orderId}
            </foreach>
        </if>
        GROUP BY sku_code
    </select>
</mapper>
