<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="ShopOrderExt">

    <resultMap id="ShopOrderMap" type="ShopOrder">
        <id column="id" property="id"/>
        <result column="order_code" property="orderCode"/>
        <result column="shop_id" property="shopId"/>
        <result column="buyer_id" property="buyerId"/>
        <result column="fee" property="fee"/>
        <result column="status" property="status"/>
        <result column="handle_status" property="handleStatus"/>
        <result column="type" property="type"/>
        <result column="buyer_name" property="buyerName"/>
        <result column="out_buyer_id" property="outBuyerId"/>
        <result column="shop_name" property="shopName"/>
        <result column="out_shop_id" property="outShopId"/>
        <result column="company_id" property="companyId"/>
        <result column="referer_id" property="refererId"/>
        <result column="referer_name" property="refererName"/>
        <result column="origin_fee" property="originFee"/>
        <result column="discount" property="discount"/>
        <result column="ship_fee" property="shipFee"/>
        <result column="origin_ship_fee" property="originShipFee"/>
        <result column="integral" property="integral"/>
        <result column="balance" property="balance"/>
        <result column="promotion_id" property="promotionId"/>
        <result column="shipment_type" property="shipmentType"/>
        <result column="pay_type" property="payType"/>
        <result column="channel" property="channel"/>
        <result column="has_refund" property="hasRefund"/>
        <result column="commented" property="commented"/>
        <result column="buyer_note" property="buyerNote"/>
        <result column="extra_json" property="extraJson"/>
        <result column="tags_json" property="tagsJson"/>
        <result column="out_id" property="outId"/>
        <result column="out_from" property="outFrom"/>
        <result column="system_auto_expired_at" property="systemAutoExpiredAt"/>
        <result column="commission_rate" property="commissionRate"/>
        <result column="distribution_rate" property="distributionRate"/>
        <result column="diff_fee" property="diffFee"/>
        <result column="out_created_at" property="outCreatedAt"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>
    <sql id="cols_all">
        id,
        <include refid="cols_exclude_id"/>
    </sql>

    <sql id="cols_exclude_id">
        `order_code`,`shop_id`,`buyer_id`,`fee`,`status`,`handle_status`,`type`,`buyer_name`,`out_buyer_id`,`shop_name`,`out_shop_id`,`company_id`,referer_id,referer_name,
        `origin_fee`,`discount`,`ship_fee`,`origin_ship_fee`,`integral`,`balance`,
        `shipment_type`,`pay_type`,`channel`,`has_refund`,`commented`,`buyer_note`,`extra_json`,`tags_json`,`out_id`,
        `out_from`, `system_auto_expired_at`, `commission_rate`,`distribution_rate`,`diff_fee`,out_created_at,`created_at`,`updated_at`
    </sql>
    <sql id="tb">
        parana_shop_orders
    </sql>

    <update id="update" parameterType="ShopOrderExt">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now()
        <if test="buyerNote != null">,`buyer_note` = #{buyerNote}</if>
        <if test="buyerName != null">,`buyer_name` = #{buyerName}</if>
        <if test="outBuyerId != null">,`out_buyer_id` = #{outBuyerId}</if>
        WHERE id=#{id}
    </update>

    <update id="updateHandleStatus" parameterType="ShopOrderExt">
        UPDATE
        <include refid="tb"/>
        SET updated_at=now(),
        handle_status = #{newHandleStatus}
        WHERE id=#{id} AND handle_status = #{originHandleStatus}
    </update>

    <select id="findByOutIdsAndOutFrom" parameterType="map" resultMap="ShopOrderMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE
        out_id IN
        <foreach collection="outIds" open="(" separator="," close=")" item="outId">
            #{outId}
        </foreach>
        AND out_from = #{outFrom}
    </select>

    <select id="findByOutIdAndOutFrom" parameterType="map" resultMap="ShopOrderMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        <where>
            <if test="outId != null">AND <![CDATA[out_id = #{outId}]]> </if>
            <if test="outFrom != null">AND <![CDATA[out_from = #{outFrom}]]> </if>
        </where>
    </select>
    
    <select id="findByecpOrderStatus" parameterType="map" resultMap="ShopOrderMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE JSON_VALID(extra_json) = 1 AND JSON_UNQUOTE(JSON_EXTRACT(extra_json, "$.ecpOrderStatus") ) = -1
		AND `status` in (4,5)
		<if test="dtStart != null">AND <![CDATA[created_at >= #{dtStart}]]> </if>
        <if test="dtEnd != null">AND <![CDATA[created_at <= #{dtEnd}]]> </if>
        <if test="shop_name != null">AND <![CDATA[shop_name = #{shop_name}]]> </if>
        <if test="shop_id != null">AND <![CDATA[shop_id = #{shop_id}]]> </if>
        <if test="out_id != null">AND <![CDATA[out_id = #{out_id}]]> </if>
        <if test="buyer_name != null">AND <![CDATA[buyer_name = #{buyer_name}]]> </if>
        <if test="order_code != null">AND <![CDATA[order_code = #{order_code}]]> </if>
        <if test="mobile != null">AND <![CDATA[out_buyer_id = #{mobile}]]> </if>
        <if test="exclude_out_from != null">AND <![CDATA[out_from != #{exclude_out_from}]]> </if>
        <if test="company_id != null">AND <![CDATA[company_id = #{company_id}]]> </if>
        <if test="allow_shop_ids != null">AND shop_id IN
            <foreach collection="allow_shop_ids" open="(" separator="," close=")" item="shop_id">
                #{shop_id}
            </foreach>
        </if>
		LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <select id="findByecpOrderStatusCount" parameterType="map" resultType="long">
        SELECT COUNT(1)
        FROM
        <include refid="tb"/>
        WHERE JSON_VALID(extra_json) = 1 AND JSON_UNQUOTE(JSON_EXTRACT(extra_json, "$.ecpOrderStatus") ) = -1
		AND `status` in (4,5)
		<if test="dtStart != null">AND <![CDATA[created_at >= #{dtStart}]]> </if>
        <if test="dtEnd != null">AND <![CDATA[created_at <= #{dtEnd}]]> </if>
        <if test="shop_name != null">AND <![CDATA[shop_name = #{shop_name}]]> </if>
        <if test="shop_id != null">AND <![CDATA[shop_id = #{shop_id}]]> </if>
        <if test="out_id != null">AND <![CDATA[out_id = #{out_id}]]> </if>
        <if test="buyer_name != null">AND <![CDATA[buyer_name = #{buyer_name}]]> </if>
        <if test="order_code != null">AND <![CDATA[order_code = #{order_code}]]> </if>
        <if test="mobile != null">AND <![CDATA[out_buyer_id = #{mobile}]]> </if>
        <if test="exclude_out_from != null">AND <![CDATA[out_from != #{exclude_out_from}]]> </if>
        <if test="company_id != null">AND <![CDATA[company_id = #{company_id}]]> </if>
        <if test="allow_shop_ids != null">AND shop_id IN
            <foreach collection="allow_shop_ids" open="(" separator="," close=")" item="shop_id">
                #{shop_id}
            </foreach>
        </if>
    </select>
</mapper>